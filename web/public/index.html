<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Or & Pièces — v0</title>
  <style>
    body{font-family:system-ui, sans-serif;margin:0;padding:16px;background:#0b0c10;color:#e5e7eb}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#111827;border:1px solid #374151;border-radius:8px;padding:12px;flex:1 1 480px}
    #spotChart,#coinChart{height:320px}
    label{opacity:.8;margin-right:6px}
    select,button{background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:6px;padding:6px 8px}
    /* Tabs */
    .tabs{display:flex;gap:6px;align-items:center;margin-bottom:8px}
    .tab-btn{background:#111827;border:1px solid #374151;color:#e5e7eb;padding:6px 10px;border-radius:6px;cursor:pointer}
    .tab-btn.active{background:#374151}
    .hidden{display:none !important}
    .segmented{display:inline-flex;border:1px solid #374151;border-radius:8px;overflow:hidden}
    .segmented button{border:0;border-right:1px solid #374151;background:#0f172a;color:#e5e7eb;padding:6px 10px}
    .segmented button:last-child{border-right:0}
    .segmented button.active{background:#334155}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <header>
    <h2 style="margin:0">Or & Pièces — v0</h2>
    <div class="tabs" role="tablist">
      <button id="tabBtnSpot" class="tab-btn active" role="tab" aria-controls="tabSpot" aria-selected="true">Spot Or</button>
      <button id="tabBtnCoins" class="tab-btn" role="tab" aria-controls="tabCoins" aria-selected="false">Pièces</button>
    </div>
    <label>Devise</label>
    <select id="currency">
      <option value="USD" selected>USD</option>
      <option value="EUR">EUR</option>
    </select>
    <span id="spotControls" style="display:flex;gap:8px;align-items:center">
      <label style="margin-left:8px">Période</label>
      <span class="segmented" role="group" aria-label="Période">
        <button class="range-btn active" data-range="1Y">1A</button>
        <button class="range-btn" data-range="6M">6M</button>
        <button class="range-btn" data-range="3M">3M</button>
        <button class="range-btn" data-range="1M">1M</button>
        <button class="range-btn" data-range="YTD">YTD</button>
        <button class="range-btn" data-range="5Y">5A</button>
        <button class="range-btn" data-range="10Y">10A</button>
        <button class="range-btn" data-range="MAX">Max</button>
      </span>
    </span>
    <span id="coinControls">
      <label style="margin-left:8px">Pièce</label>
      <select id="coin"></select>
      <label style="margin-left:8px">Vendeur</label>
      <select id="vendor"></select>
    </span>
    <button id="refresh">Rafraîchir</button>
    <div id="providers" style="margin-left:auto;display:flex;gap:8px"></div>
  </header>

  <div id="tabSpot" class="row" role="tabpanel" aria-labelledby="tabBtnSpot">
    <div class="card" style="flex: 1 1 100%">
      <h3 id="spotTitle" style="margin:0 0 8px">Spot Or</h3>
      <div id="spotChart"></div>
    </div>
  </div>

  <div id="tabCoins" class="row hidden" role="tabpanel" aria-labelledby="tabBtnCoins">
    <div class="card" style="flex: 1 1 100%">
      <h3 style="margin:0 0 8px">Vue instantanée</h3>
      <div id="now" style="display:flex;gap:24px;flex-wrap:wrap">
        <div>
          <div style="opacity:.7">Prix actuel</div>
          <div id="nowPrice" style="font-size:28px">—</div>
          <div id="nowVendor" style="opacity:.7;font-size:12px">—</div>
        </div>
        <div>
          <div style="opacity:.7">Valeur de fonte</div>
          <div id="nowMelt" style="font-size:28px">—</div>
          <div id="nowSpotTs" style="opacity:.7;font-size:12px">—</div>
        </div>
        <div>
          <div style="opacity:.7">Prime</div>
          <div id="nowPremium" style="font-size:28px">—</div>
          <div id="nowPriceTs" style="opacity:.7;font-size:12px">—</div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3 id="coinTitle" style="margin:0 0 8px">Pièce — Prix vs Fonte/Prime</h3>
      <div id="coinChart"></div>
    </div>
  </div>

<script>
const apiBase = '';
async function fetchJSON(path){ const r = await fetch(path); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// Providers health badges
async function loadProviders(){
  try{
    const rows = await fetchJSON('/health/providers');
    const el = document.getElementById('providers');
    el.innerHTML = '';
    for (const s of rows) {
      const badge = document.createElement('div');
      badge.style.padding = '4px 8px';
      badge.style.borderRadius = '6px';
      badge.style.fontSize = '12px';
      badge.style.border = '1px solid #374151';
      const ok = s.enabled && s.configured && s.ok !== false;
      badge.style.background = ok ? '#064e3b' : '#7f1d1d';
      badge.style.color = '#e5e7eb';
      badge.title = s.last_error ? `status: ${s.last_error}` : 'ok';
      badge.textContent = s.name + (ok ? ' ✓' : ' ✕');
      el.appendChild(badge);
    }
  }catch(e){ /* ignore */ }
}

// Basic store + UI state
let coins = [];
let coinMap = new Map();
let activeTab = 'spot'; // 'spot' | 'coins'

async function loadSpot(currency, doRefresh){
  const rows = await fetchJSON(`/spot?currency=${currency}${doRefresh ? '&refresh=1' : ''}`);
  return rows.map(r => ({ t: r.ts_utc, oz: r.price_per_oz, g: r.price_per_g }));
}

async function loadPremium(coinId, currency){
  const rows = await fetchJSON(`/premium?coin_id=${encodeURIComponent(coinId)}&currency=${currency}`);
  return rows.map(r => ({ t: r.ts_utc, price: r.price, melt: r.melt_value, prem: r.premium_pct, vendor: r.vendor, currency: r.currency }));
}

async function loadCoins(){
  coins = await fetchJSON('/coins');
  coinMap = new Map(coins.map(c => [c.id, c]));
  const sel = document.getElementById('coin');
  sel.innerHTML = '';
  for (const c of coins) {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    sel.appendChild(opt);
  }
  const def = coins.find(c => c.id.includes('krugerrand'))?.id || coins[0]?.id;
  if (def) sel.value = def;
}

async function loadVendors(coinId, currency){
  const rows = await fetchJSON(`/prices?coin_id=${encodeURIComponent(coinId)}`);
  const vendors = Array.from(new Set(rows.filter(r => r.currency === currency).map(r => r.vendor)));
  const sel = document.getElementById('vendor');
  sel.innerHTML = '';
  const all = document.createElement('option'); all.value = ''; all.textContent = 'Tous vendeurs'; sel.appendChild(all);
  for (const v of vendors) { const opt = document.createElement('option'); opt.value = v; opt.textContent = v; sel.appendChild(opt); }
}

function spotChart(el, data, currency){
  const chart = echarts.init(el);
  chart.setOption({
    backgroundColor: '#111827',
    textStyle: { color: '#e5e7eb' },
    tooltip: { trigger: 'axis', valueFormatter: v => fmt(v, currency) },
    xAxis: { type: 'time' },
    yAxis: { type: 'value', name: `${currency}/oz` },
    dataZoom: [
      { type: 'inside', throttle: 50 },
      { type: 'slider', height: 24 }
    ],
    toolbox: { feature: { restore: {}, saveAsImage: {} } },
    series: [{ type: 'line', name: `Spot (${currency}/oz)`, showSymbol:false, sampling: 'lttb', data: data.map(d => [d.t, d.oz]) }]
  });
}

function coinChart(el, series){
  const chart = echarts.init(el);
  const seriesCurrency = series[0]?.currency || 'USD';
  chart.setOption({
    backgroundColor: '#111827', textStyle: { color: '#e5e7eb' }, tooltip: { trigger: 'axis' },
    legend: { data: ['Prix', 'Fonte', 'Prime %'] },
    xAxis: [{ type: 'time' }],
    yAxis: [{ type: 'value', name: seriesCurrency }, { type: 'value', name: 'Prime %', position: 'right' }],
    series: [
      { type: 'line', name: 'Prix', showSymbol:false, data: series.map(r => [r.t, r.price]) },
      { type: 'line', name: 'Fonte', showSymbol:false, data: series.map(r => [r.t, r.melt]) },
      { type: 'line', name: 'Prime %', yAxisIndex: 1, showSymbol:false, data: series.map(r => [r.t, (r.prem*100).toFixed(2)]) }
    ]
  });
}

function fmt(n, currency){
  try { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency }).format(n); } catch { return String(n); }
}

function computeMelt(spotPerOz, fineWeightG){
  const perG = spotPerOz / 31.1034768;
  return perG * fineWeightG;
}

async function render(doRefresh=false){
  const currency = document.getElementById('currency').value;
  if (activeTab === 'spot') {
    const { fromIso } = computeSpotFrom();
    const qs = new URLSearchParams({ currency, group: 'daily' });
    if (fromIso) qs.set('from', fromIso);
    if (doRefresh) qs.set('refresh', '1');
    const rows = await fetchJSON(`/spot?${qs.toString()}`);
    const spot = rows.map(r => ({ t: r.ts_utc, oz: r.price_per_oz, g: r.price_per_g }));
    document.getElementById('spotTitle').textContent = `Spot Or (${currency}/oz)`;
    spotChart(document.getElementById('spotChart'), spot, currency);
    return;
  }

  // coins tab
  const coinId = document.getElementById('coin').value;
  await loadVendors(coinId, currency);
  const vendor = document.getElementById('vendor').value;

  let prem = await loadPremium(coinId, currency);
  if (prem.length === 0 && currency === 'USD') {
    prem = await loadPremium(coinId, 'AUTO');
  }
  const premFiltered = vendor ? prem.filter(r => r.vendor === vendor) : prem;
  const displayCurrency = premFiltered[0]?.currency || currency;
  document.getElementById('coinTitle').textContent = `${coinMap.get(coinId)?.name || 'Pièce'} — Prix vs Fonte/Prime (${displayCurrency})`;
  coinChart(document.getElementById('coinChart'), premFiltered);

  const latestPrice = premFiltered.slice().sort((a,b) => a.t.localeCompare(b.t)).slice(-1)[0];
  const nowPriceEl = document.getElementById('nowPrice');
  const nowVendorEl = document.getElementById('nowVendor');
  const nowMeltEl = document.getElementById('nowMelt');
  const nowPremEl = document.getElementById('nowPremium');
  const nowSpotTs = document.getElementById('nowSpotTs');
  const nowPriceTs = document.getElementById('nowPriceTs');
  if (!latestPrice) {
    nowPriceEl.textContent = '—'; nowVendorEl.textContent = 'Aucun prix dans cette devise';
    nowMeltEl.textContent = '—'; nowPremEl.textContent = '—'; nowSpotTs.textContent='—'; nowPriceTs.textContent='—';
  } else {
    const melt = latestPrice.melt;
    const premiumPct = latestPrice.prem;
    const cur = latestPrice.currency || currency;
    nowPriceEl.textContent = fmt(latestPrice.price, cur);
    nowVendorEl.textContent = `${latestPrice.vendor || '—'} · prix: ${new Date(latestPrice.t).toLocaleString()}`;
    nowMeltEl.textContent = fmt(melt, cur);
    nowPremEl.textContent = `${(premiumPct*100).toFixed(2)} %`;
    nowPremEl.style.color = premiumPct >= 0 ? '#34d399' : '#f87171';
    nowSpotTs.textContent = `spot: utilisé pour calculer la fonte`;
    nowPriceTs.textContent = `calculé vs spot`;
  }
}

function setTab(tab){
  activeTab = tab;
  const tabSpot = document.getElementById('tabSpot');
  const tabCoins = document.getElementById('tabCoins');
  const coinControls = document.getElementById('coinControls');
  const btnSpot = document.getElementById('tabBtnSpot');
  const btnCoins = document.getElementById('tabBtnCoins');
  const onSpot = tab === 'spot';
  tabSpot.classList.toggle('hidden', !onSpot);
  tabCoins.classList.toggle('hidden', onSpot);
  coinControls.classList.toggle('hidden', onSpot);
  btnSpot.classList.toggle('active', onSpot);
  btnCoins.classList.toggle('active', !onSpot);
  btnSpot.setAttribute('aria-selected', onSpot ? 'true' : 'false');
  btnCoins.setAttribute('aria-selected', !onSpot ? 'true' : 'false');
  render(false);
}

// Spot range state and helpers
let spotRange = '1Y';
function selectRange(key){
  spotRange = key;
  document.querySelectorAll('.range-btn').forEach(b => b.classList.toggle('active', b.dataset.range === key));
  if (activeTab === 'spot') render(false);
}
function computeSpotFrom(){
  const now = new Date();
  now.setUTCHours(0,0,0,0);
  const toIso = null; // unused for now
  const d = new Date(now);
  switch(spotRange){
    case '1M': d.setUTCMonth(d.getUTCMonth()-1); break;
    case '3M': d.setUTCMonth(d.getUTCMonth()-3); break;
    case '6M': d.setUTCMonth(d.getUTCMonth()-6); break;
    case '1Y': d.setUTCFullYear(d.getUTCFullYear()-1); break;
    case '5Y': d.setUTCFullYear(d.getUTCFullYear()-5); break;
    case '10Y': d.setUTCFullYear(d.getUTCFullYear()-10); break;
    case 'YTD': d.setUTCFullYear(d.getUTCFullYear(), 0, 1); break; // Jan 1 current year
    case 'MAX': return { fromIso: null, toIso };
    default: d.setUTCFullYear(d.getUTCFullYear()-1);
  }
  const fromIso = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString();
  return { fromIso, toIso };
}

async function boot(){
  await loadCoins();
  await loadProviders();
  document.getElementById('tabBtnSpot').addEventListener('click', () => setTab('spot'));
  document.getElementById('tabBtnCoins').addEventListener('click', () => setTab('coins'));
  document.querySelectorAll('.range-btn').forEach(btn => btn.addEventListener('click', () => selectRange(btn.dataset.range)));
  document.getElementById('coin').addEventListener('change', () => activeTab==='coins' && render(false));
  document.getElementById('vendor').addEventListener('change', () => activeTab==='coins' && render(false));
  document.getElementById('currency').addEventListener('change', () => render(false));
  document.getElementById('refresh').addEventListener('click', () => render(true));
  // Démarre sur l'onglet Spot
  setTab('spot');
}

boot();
</script>
</body>
</html>
