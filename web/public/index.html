<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Or & Pièces — v0</title>
  <style>
    body{font-family:system-ui, sans-serif;margin:0;padding:16px;background:#0b0c10;color:#e5e7eb}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#111827;border:1px solid #374151;border-radius:8px;padding:12px;flex:1 1 480px}
    #spotChart,#coinChart{height:320px}
    label{opacity:.8;margin-right:6px}
    select,button{background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:6px;padding:6px 8px}
    /* Tabs */
    .tabs{display:flex;gap:6px;align-items:center;margin-bottom:8px}
    .tab-btn{background:#111827;border:1px solid #374151;color:#e5e7eb;padding:6px 10px;border-radius:6px;cursor:pointer}
    .tab-btn.active{background:#374151}
    .hidden{display:none !important}
    .segmented{display:inline-flex;border:1px solid #374151;border-radius:8px;overflow:hidden}
    .segmented button{border:0;border-right:1px solid #374151;background:#0f172a;color:#e5e7eb;padding:6px 10px}
    .segmented button:last-child{border-right:0}
    .segmented button.active{background:#334155}
    .coins-grid{overflow-x:auto}
    .coins-grid table{width:100%;border-collapse:collapse;font-size:14px}
    .coins-grid th,.coins-grid td{padding:10px 12px;text-align:left;border-bottom:1px solid #374151}
    .coins-grid th{opacity:.85;font-weight:600}
    .coins-grid tr:hover{background:#1f2937}
    .coins-grid .no-data{opacity:.5}
    .coins-grid .prime-pos{color:#34d399}
    .coins-grid .prime-neg{color:#f87171}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <header>
    <h2 style="margin:0">Or & Pièces — v0</h2>
    <div class="tabs" role="tablist">
      <button id="tabBtnSpot" class="tab-btn active" role="tab" aria-controls="tabSpot" aria-selected="true">Spot Or</button>
      <button id="tabBtnCoins" class="tab-btn" role="tab" aria-controls="tabCoins" aria-selected="false">Pièces</button>
    </div>
    <label>Devise</label>
    <select id="currency">
      <option value="USD">USD</option>
      <option value="EUR" selected>EUR</option>
    </select>
    <span id="spotControls" style="display:flex;gap:8px;align-items:center">
      <label style="margin-left:8px">Période</label>
      <span class="segmented" role="group" aria-label="Période">
        <button class="range-btn" data-range="1M">1M</button>
        <button class="range-btn" data-range="3M">3M</button>
        <button class="range-btn" data-range="6M">6M</button>
        <button class="range-btn" data-range="YTD">YTD</button>
        <button class="range-btn active" data-range="1Y">1A</button>
        <button class="range-btn" data-range="5Y">5A</button>
        <button class="range-btn" data-range="10Y">10A</button>
        <button class="range-btn" data-range="MAX">Max</button>
      </span>
    </span>
    <button id="refresh">Rafraîchir</button>
    <div id="providers" style="margin-left:auto;display:flex;gap:8px"></div>
  </header>

  <div id="tabSpot" class="row" role="tabpanel" aria-labelledby="tabBtnSpot">
    <div class="card" style="flex: 1 1 100%">
      <h3 id="spotTitle" style="margin:0 0 8px">Spot Or</h3>
      <div id="spotChart"></div>
    </div>
  </div>

  <div id="tabCoins" class="row hidden" role="tabpanel" aria-labelledby="tabBtnCoins">
    <div class="card" style="flex: 1 1 100%">
      <h3 style="margin:0 0 12px">Pièces — Prix actuel, valeur de fonte, prime</h3>
      <div id="coinsGrid" class="coins-grid"></div>
    </div>
  </div>

<script>
const apiBase = '';
async function fetchJSON(path){ const r = await fetch(path); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// Providers health badges
async function loadProviders(){
  try{
    const rows = await fetchJSON('/health/providers');
    const el = document.getElementById('providers');
    el.innerHTML = '';
    for (const s of rows) {
      const badge = document.createElement('div');
      badge.style.padding = '4px 8px';
      badge.style.borderRadius = '6px';
      badge.style.fontSize = '12px';
      badge.style.border = '1px solid #374151';
      const ok = s.enabled && s.configured && s.ok !== false;
      badge.style.background = ok ? '#064e3b' : '#7f1d1d';
      badge.style.color = '#e5e7eb';
      badge.title = s.last_error ? `status: ${s.last_error}` : 'ok';
      badge.textContent = s.name + (ok ? ' ✓' : ' ✕');
      el.appendChild(badge);
    }
  }catch(e){ /* ignore */ }
}

// Basic store + UI state
let coins = [];
let coinMap = new Map();
let activeTab = 'spot'; // 'spot' | 'coins'

async function fetchSpot(currency, doRefresh, fromIso){
  const qs = new URLSearchParams({ currency, group: 'daily' });
  if (fromIso) qs.set('from', fromIso);
  if (doRefresh) qs.set('refresh', '1');
  const r = await fetch(`/spot?${qs.toString()}`);
  if (!r.ok) throw new Error('HTTP ' + r.status);
  const rows = await r.json();
  const effectiveCurrency = r.headers.get('X-Spot-Effective-Currency') || currency;
  return { data: rows.map(x => ({ t: x.ts_utc, oz: x.price_per_oz, g: x.price_per_g })), effectiveCurrency };
}

async function loadPremium(coinId, currency){
  const rows = await fetchJSON(`/premium?coin_id=${encodeURIComponent(coinId)}&currency=${currency}`);
  return rows.map(r => ({ t: r.ts_utc, price: r.price, melt: r.melt_value, prem: r.premium_pct, vendor: r.vendor, currency: r.currency }));
}

async function loadCoins(){
  coins = await fetchJSON('/coins');
  coinMap = new Map(coins.map(c => [c.id, c]));
}

async function loadCoinsSummary(currency){
  return fetchJSON(`/coins/summary?currency=${encodeURIComponent(currency)}`);
}

function escapeHtml(s){
  if (s == null) return '';
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function spotChart(el, data, currency){
  const chart = echarts.init(el);
  const points = data.map(d => [d.t, d.oz]);
  const fewPoints = points.length <= 20;
  chart.setOption({
    backgroundColor: '#111827',
    textStyle: { color: '#e5e7eb' },
    tooltip: { trigger: 'axis', valueFormatter: v => fmt(v, currency) },
    xAxis: { type: 'time' },
    yAxis: {
      type: 'value',
      name: `${currency}/oz`,
      scale: true,
      min: fewPoints ? 'dataMin' : undefined,
      max: fewPoints ? 'dataMax' : undefined,
      minInterval: fewPoints ? undefined : null
    },
    dataZoom: [
      { type: 'inside', throttle: 50 },
      { type: 'slider', height: 24 }
    ],
    toolbox: { feature: { restore: {}, saveAsImage: {} } },
    series: [{
      type: 'line',
      name: `Spot (${currency}/oz)`,
      showSymbol: fewPoints,
      symbolSize: fewPoints ? 8 : 0,
      sampling: fewPoints ? undefined : 'lttb',
      data: points
    }]
  });
}

function fmt(n, currency){
  try { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency }).format(n); } catch { return String(n); }
}

function computeMelt(spotPerOz, fineWeightG){
  const perG = spotPerOz / 31.1034768;
  return perG * fineWeightG;
}

async function render(doRefresh=false){
  const currency = document.getElementById('currency').value;
  if (activeTab === 'spot') {
    const { fromIso } = computeSpotFrom();
    const { data: spot, effectiveCurrency } = await fetchSpot(currency, doRefresh, fromIso);
    document.getElementById('spotTitle').textContent = `Spot Or (${effectiveCurrency}/oz)`;
    spotChart(document.getElementById('spotChart'), spot, effectiveCurrency);
    return;
  }

  // coins tab — grille de toutes les pièces
  const summary = await loadCoinsSummary(currency);
  const gridEl = document.getElementById('coinsGrid');
  gridEl.innerHTML = '';
  const table = document.createElement('table');
  table.setAttribute('role', 'table');
  table.innerHTML = `<thead><tr><th>Pièce</th><th>Prix actuel</th><th>Valeur de fonte</th><th>Prime</th><th>Vendeur</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  const cur = summary[0]?.currency || currency;
  for (const row of summary) {
    const tr = document.createElement('tr');
    if (!row.has_data) tr.classList.add('no-data');
    const priceCell = row.has_data ? fmt(row.price_now, cur) : '—';
    const meltCell = row.melt_now != null ? fmt(row.melt_now, cur) : '—';
    let primeCell = '—';
    let primeClass = '';
    if (row.premium_now_pct != null) {
      primeCell = (row.premium_now_pct * 100).toFixed(2) + ' %';
      primeClass = row.premium_now_pct >= 0 ? 'prime-pos' : 'prime-neg';
    }
    const vendorCell = row.vendor || '—';
    tr.innerHTML = `<td>${escapeHtml(row.name)}</td><td>${priceCell}</td><td>${meltCell}</td><td class="${primeClass}">${primeCell}</td><td>${escapeHtml(vendorCell)}</td>`;
    tbody.appendChild(tr);
  }
  gridEl.appendChild(table);
}

function setTab(tab){
  activeTab = tab;
  const tabSpot = document.getElementById('tabSpot');
  const tabCoins = document.getElementById('tabCoins');
  const btnSpot = document.getElementById('tabBtnSpot');
  const btnCoins = document.getElementById('tabBtnCoins');
  const spotControls = document.getElementById('spotControls');
  const onSpot = tab === 'spot';
  tabSpot.classList.toggle('hidden', !onSpot);
  tabCoins.classList.toggle('hidden', onSpot);
  if (spotControls) spotControls.style.display = onSpot ? 'flex' : 'none';
  btnSpot.classList.toggle('active', onSpot);
  btnCoins.classList.toggle('active', !onSpot);
  btnSpot.setAttribute('aria-selected', onSpot ? 'true' : 'false');
  btnCoins.setAttribute('aria-selected', !onSpot ? 'true' : 'false');
  render(false);
}

// Spot range state and helpers
let spotRange = '1Y';
function selectRange(key){
  spotRange = key;
  document.querySelectorAll('.range-btn').forEach(b => b.classList.toggle('active', b.dataset.range === key));
  if (activeTab === 'spot') render(false);
}
function computeSpotFrom(){
  const now = new Date();
  now.setUTCHours(0,0,0,0);
  const toIso = null; // unused for now
  const d = new Date(now);
  switch(spotRange){
    case '1M': d.setUTCMonth(d.getUTCMonth()-1); break;
    case '3M': d.setUTCMonth(d.getUTCMonth()-3); break;
    case '6M': d.setUTCMonth(d.getUTCMonth()-6); break;
    case '1Y': d.setUTCFullYear(d.getUTCFullYear()-1); break;
    case '5Y': d.setUTCFullYear(d.getUTCFullYear()-5); break;
    case '10Y': d.setUTCFullYear(d.getUTCFullYear()-10); break;
    case 'YTD': d.setUTCFullYear(d.getUTCFullYear(), 0, 1); break; // Jan 1 current year
    case 'MAX': return { fromIso: null, toIso };
    default: d.setUTCFullYear(d.getUTCFullYear()-1);
  }
  const fromIso = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString();
  return { fromIso, toIso };
}

async function boot(){
  await loadCoins();
  await loadProviders();
  document.getElementById('tabBtnSpot').addEventListener('click', () => setTab('spot'));
  document.getElementById('tabBtnCoins').addEventListener('click', () => setTab('coins'));
  document.querySelectorAll('.range-btn').forEach(btn => btn.addEventListener('click', () => selectRange(btn.dataset.range)));
  document.getElementById('currency').addEventListener('change', () => render(false));
  document.getElementById('refresh').addEventListener('click', () => render(true));
  // Démarre sur l'onglet Spot
  setTab('spot');
}

boot();
</script>
</body>
</html>
